<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>P2P File Sharer</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <style>
        body { font-family: sans-serif; padding: 20px; max-width: 600px; margin: auto; }
        h2 { border-bottom: 2px solid #eee; padding-bottom: 5px; }
        .box { border: 1px solid #ccc; padding: 15px; margin-bottom: 20px; border-radius: 5px; }
        #status { font-weight: bold; color: blue; }
        input[type="file"] { margin-top: 10px; }
    </style>
</head>
<body>
    <h1>ğŸ¤ ã‚µãƒ¼ãƒãƒ¼ãƒ¬ã‚¹ãƒ»ãƒ•ã‚¡ã‚¤ãƒ«å…±æœ‰</h1>
    <p>ã“ã®ã‚µãƒ¼ãƒ“ã‚¹ã¯PeerJSã®ç„¡æ–™ã‚·ã‚°ãƒŠãƒªãƒ³ã‚°ã‚µãƒ¼ãƒãƒ¼ã‚’åˆ©ç”¨ã—ã€ãƒ•ã‚¡ã‚¤ãƒ«ãƒ‡ãƒ¼ã‚¿ã¯ãƒ–ãƒ©ã‚¦ã‚¶é–“ã§ç›´æ¥è»¢é€ã•ã‚Œã¾ã™ã€‚</p>

    <div class="box">
        <h2>â‘  æ¥ç¶šçŠ¶æ³</h2>
        <p>ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹: <span id="status">æœªæ¥ç¶š</span></p>
        <p>ã‚ãªãŸã®ID: <strong id="my-id">...ãƒ­ãƒ¼ãƒ‰ä¸­...</strong></p>
    </div>

    <div class="box">
        <h2>â‘¡ ãƒ•ã‚¡ã‚¤ãƒ«ã®é€ä¿¡</h2>
        <p>ç›¸æ‰‹ã«ã“ã®IDã‚’ä¼ãˆã¦ãã ã•ã„ã€‚ç›¸æ‰‹ãŒæ¥ç¶šã—ãŸã‚‰ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é€ä¿¡ã§ãã¾ã™ã€‚</p>
        <label for="target-id">ç›¸æ‰‹ã®IDã‚’å…¥åŠ›:</label>
        <input type="text" id="target-id" placeholder="ç›¸æ‰‹ã®ID">
        <button onclick="connectToPeer()">æ¥ç¶šã™ã‚‹</button>

        <hr>

        <label for="file-input">é€ä¿¡ã—ãŸã„ãƒ•ã‚¡ã‚¤ãƒ«:</label>
        <input type="file" id="file-input">
        <button onclick="sendFile()" disabled id="send-btn">é€ä¿¡é–‹å§‹</button>
        <p id="send-log" style="color: green;"></p>
    </div>

    <div class="box">
        <h2>â‘¢ ãƒ•ã‚¡ã‚¤ãƒ«ã®å—ä¿¡</h2>
        <p>ç›¸æ‰‹ã‹ã‚‰ã®æ¥ç¶šã‚’å¾…ã£ã¦ã„ã¾ã™...</p>
        <div id="receive-log"></div>
    </div>

    <script>
        // PeerJSã‚’èª­ã¿è¾¼ã‚€ï¼ˆã‚·ã‚°ãƒŠãƒªãƒ³ã‚°ã‚µãƒ¼ãƒãƒ¼ã¨ã—ã¦æ©Ÿèƒ½ã™ã‚‹å¤–éƒ¨ã‚µãƒ¼ãƒ“ã‚¹ï¼‰
        const peer = new Peer();
        const myIdElement = document.getElementById('my-id');
        const statusElement = document.getElementById('status');
        const sendBtn = document.getElementById('send-btn');
        let connection; // ç¢ºç«‹ã•ã‚ŒãŸæ¥ç¶šã‚’ä¿æŒã™ã‚‹ãŸã‚ã®å¤‰æ•°

        // ----------------------------------------------------
        // A. ãƒ”ã‚¢ï¼ˆè‡ªåˆ†è‡ªèº«ï¼‰ã®åˆæœŸåŒ–
        // ----------------------------------------------------

        peer.on('open', (id) => {
            // è‡ªåˆ†ã®ãƒ¦ãƒ‹ãƒ¼ã‚¯IDãŒç¢ºå®šã—ãŸ
            myIdElement.textContent = id;
            statusElement.textContent = 'æº–å‚™å®Œäº†';
            statusElement.style.color = 'green';
        });

        peer.on('error', (err) => {
            console.error(err);
            statusElement.textContent = 'ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ';
            statusElement.style.color = 'red';
        });

        // ----------------------------------------------------
        // B. ç›¸æ‰‹ã‹ã‚‰ã®æ¥ç¶šã‚’å—ä¿¡ã—ãŸã¨ãï¼ˆå—ä¿¡å´ï¼‰
        // ----------------------------------------------------

        peer.on('connection', (conn) => {
            handleConnection(conn, true); // ç¬¬2å¼•æ•°: true=å—ä¿¡å´
        });

        // ----------------------------------------------------
        // C. ç›¸æ‰‹ã«æ¥ç¶šã‚’é–‹å§‹ã™ã‚‹ã¨ãï¼ˆé€ä¿¡å´ï¼‰
        // ----------------------------------------------------

        function connectToPeer() {
            const targetId = document.getElementById('target-id').value;
            if (!targetId || targetId === peer.id) {
                alert('æœ‰åŠ¹ãªç›¸æ‰‹ã®IDã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚');
                return;
            }
            statusElement.textContent = 'æ¥ç¶šä¸­...';
            // ç›¸æ‰‹IDã‚’æŒ‡å®šã—ã¦æ¥ç¶šé–‹å§‹
            const conn = peer.connect(targetId);
            handleConnection(conn, false); // ç¬¬2å¼•æ•°: false=é€ä¿¡å´
        }

        // ----------------------------------------------------
        // D. æ¥ç¶šç¢ºç«‹å¾Œã®å…±é€šå‡¦ç†
        // ----------------------------------------------------

        function handleConnection(conn, isReceiver) {
            connection = conn;

            conn.on('open', () => {
                statusElement.textContent = `æ¥ç¶šå®Œäº† (${isReceiver ? 'å—ä¿¡å´' : 'é€ä¿¡å´'})`;
                statusElement.style.color = 'purple';
                sendBtn.disabled = false; // æ¥ç¶šã§ããŸã‚‰é€ä¿¡ãƒœã‚¿ãƒ³ã‚’æœ‰åŠ¹åŒ–

                // ç›¸æ‰‹ã«ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ï¼ˆãƒ•ã‚¡ã‚¤ãƒ«åã€ã‚µã‚¤ã‚ºï¼‰ã‚’é€ã‚‹æº–å‚™
                conn.send({
                    type: 'metadata',
                    message: isReceiver ? 'æ¥ç¶šã‚’ç¢ºç«‹ã—ã¾ã—ãŸï¼' : 'æ¥ç¶šãŒç¢ºç«‹ã•ã‚Œã¾ã—ãŸï¼'
                });
            });

            conn.on('data', (data) => {
                if (data.type === 'metadata') {
                    // ãƒ•ã‚¡ã‚¤ãƒ«åã¨ã‚µã‚¤ã‚ºã‚’å—ä¿¡ï¼ˆè»¢é€å‰ï¼‰
                    handleMetadata(data);
                } else if (data.type === 'file-chunk') {
                    // ãƒ•ã‚¡ã‚¤ãƒ«ã®æ–­ç‰‡ã‚’å—ä¿¡
                    handleChunk(data);
                }
            });

            conn.on('close', () => {
                statusElement.textContent = 'æ¥ç¶šãŒåˆ‡æ–­ã•ã‚Œã¾ã—ãŸ';
                statusElement.style.color = 'red';
                sendBtn.disabled = true;
            });
        }

        // ----------------------------------------------------
        // E. é€ä¿¡å‡¦ç†ï¼ˆé€ä¿¡å´ï¼‰
        // ----------------------------------------------------

        function sendFile() {
            if (!connection || connection.open === false) {
                alert('ã¾ãšç›¸æ‰‹ã¨æ¥ç¶šã—ã¦ãã ã•ã„ã€‚');
                return;
            }

            const fileInput = document.getElementById('file-input');
            const file = fileInput.files[0];
            const sendLog = document.getElementById('send-log');

            if (!file) {
                alert('ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚');
                return;
            }

            const chunkSize = 16 * 1024; // 16KB ãšã¤ã«åˆ†å‰²
            const totalChunks = Math.ceil(file.size / chunkSize);
            let offset = 0;
            let chunkCount = 0;

            // 1. ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ã‚’é€ä¿¡
            connection.send({
                type: 'metadata',
                name: file.name,
                size: file.size,
                totalChunks: totalChunks
            });
            sendLog.textContent = `ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿é€ä¿¡å®Œäº†: ${file.name} (${(file.size / 1024 / 1024).toFixed(2)} MB)`;

            // 2. ãƒ•ã‚¡ã‚¤ãƒ«ã‚’åˆ†å‰²ã—ã¦é€ä¿¡
            function sendNextChunk() {
                if (offset >= file.size) {
                    sendLog.textContent = `âœ… å…¨ã¦ã®ãƒ•ã‚¡ã‚¤ãƒ« (${file.name}) ã®é€ä¿¡ãŒå®Œäº†ã—ã¾ã—ãŸï¼`;
                    return;
                }

                const slice = file.slice(offset, offset + chunkSize);
                const reader = new FileReader();

                reader.onload = (event) => {
                    const chunkData = event.target.result;

                    // WebRTCã®DataChannelã§é€ä¿¡ã§ãã‚‹ã®ã¯ArrayBufferãªã®ã§å¤‰æ›
                    connection.send({
                        type: 'file-chunk',
                        chunk: chunkData,
                        offset: offset
                    });
                    
                    offset += chunkSize;
                    chunkCount++;
                    
                    // é€²æ—è¡¨ç¤º
                    const progress = Math.min(100, (offset / file.size) * 100).toFixed(1);
                    sendLog.textContent = `é€ä¿¡ä¸­... (${chunkCount}/${totalChunks} | ${progress}%)`;
                    
                    // æ¬¡ã®ãƒãƒ£ãƒ³ã‚¯ã‚’éåŒæœŸã§é€ä¿¡
                    setTimeout(sendNextChunk, 10); // çŸ­ã„å¾…ã¡æ™‚é–“ã‚’è¨­ã‘ã¦ãƒ–ãƒ©ã‚¦ã‚¶ã®è² è·ã‚’è»½æ¸›
                };

                reader.readAsArrayBuffer(slice);
            }

            sendNextChunk();
        }

        // ----------------------------------------------------
        // F. å—ä¿¡å‡¦ç†ï¼ˆå—ä¿¡å´ï¼‰
        // ----------------------------------------------------

        let receivedBuffer = [];
        let metadata = null;
        let receivedBytes = 0;
        const receiveLog = document.getElementById('receive-log');

        function handleMetadata(data) {
            if (data.name && data.size) {
                // æ–°ã—ã„ãƒ•ã‚¡ã‚¤ãƒ«è»¢é€é–‹å§‹
                metadata = data;
                receivedBuffer = [];
                receivedBytes = 0;
                receiveLog.innerHTML = `<p style="color: blue;">ãƒ•ã‚¡ã‚¤ãƒ«å—ä¿¡é–‹å§‹: <strong>${data.name}</strong> (${(data.size / 1024 / 1024).toFixed(2)} MB)</p>`;
            }
        }

        function handleChunk(data) {
            if (!metadata) return;

            receivedBuffer.push(data.chunk);
            receivedBytes += data.chunk.byteLength;

            const progress = Math.min(100, (receivedBytes / metadata.size) * 100).toFixed(1);
            receiveLog.innerHTML = `<p style="color: blue;">å—ä¿¡ä¸­... ${metadata.name} (${progress}%)</p>`;

            // å…¨ã¦ã®ãƒãƒ£ãƒ³ã‚¯ã‚’å—ä¿¡å®Œäº†ã—ãŸã‹ãƒã‚§ãƒƒã‚¯
            if (receivedBytes >= metadata.size) {
                receiveLog.innerHTML = `<p style="color: green;">âœ… å—ä¿¡å®Œäº†: <strong>${metadata.name}</strong></p>`;
                
                // ArrayBufferã®é…åˆ—ã‚’ä¸€ã¤ã®Blobã«çµåˆ
                const receivedFile = new Blob(receivedBuffer);
                
                // ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ãƒªãƒ³ã‚¯ã‚’ç”Ÿæˆ
                const downloadUrl = URL.createObjectURL(receivedFile);
                const a = document.createElement('a');
                a.href = downloadUrl;
                a.download = metadata.name;
                a.textContent = `ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰: ${metadata.name} (ã‚¯ãƒªãƒƒã‚¯ã—ã¦ä¿å­˜)`;
                a.style.display = 'block';
                a.style.marginTop = '10px';
                
                receiveLog.appendChild(a);
                
                // ãƒ¡ãƒ¢ãƒªã‚’è§£æ”¾
                URL.revokeObjectURL(downloadUrl);
                metadata = null;
            }
        }

    </script>
</body>
</html>
