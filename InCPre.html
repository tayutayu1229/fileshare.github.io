<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>çµ±åˆæŒ‡ä»¤ãƒ»é˜²ç½ã‚·ã‚¹ãƒ†ãƒ  V3.0 | Integrated Command & Disaster Prevention</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
          integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
          crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
            integrity="sha256-20n6sB8s5eOaRW88AxZfSjSH2yAHDvR+y2ftc8wQRV2M="
            crossorigin=""></script>
            
    <style>
        /* == COMMAND CENTER STYLING V3.0 == */
        :root {
            --bg-color: #0d0d0d;
            --main-text-color: #00e6e6; /* ã‚·ã‚¢ãƒ³/ã‚¿ãƒ¼ã‚³ã‚¤ã‚ºç³» */
            --panel-bg: #1a1a1a;
            --border-color: #333;
            --warning-color: #ff9900; /* ã‚ªãƒ¬ãƒ³ã‚¸ */
            --danger-color: #ff3333; /* èµ¤è‰² */
            --normal-color: #00cc66; /* ã‚°ãƒªãƒ¼ãƒ³ */
            --font-mono: 'Roboto Mono', monospace;
        }
        body {
            font-family: var(--font-mono);
            background-color: var(--bg-color);
            color: var(--main-text-color);
            margin: 0;
            padding: 0;
            display: flex;
            height: 100vh;
            overflow: hidden;
            font-size: 13px;
        }
        .header {
            width: 100%;
            background-color: #000;
            color: var(--main-text-color);
            padding: 10px 20px;
            font-size: 1.5em;
            text-align: center;
            border-bottom: 2px solid var(--main-text-color);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.5);
            position: fixed;
            top: 0;
            z-index: 1000;
        }
        .container {
            display: flex;
            width: 100%;
            padding-top: 55px;
            flex-grow: 1; 
            height: calc(100% - 55px); /* Headeråˆ†ã®é«˜ã•ã‚’å¼•ã */
        }

        /* å·¦å´ãƒ‘ãƒãƒ« (åœ°å›³ & æ°—è±¡) */
        .left-column {
            flex: 2; 
            display: flex;
            flex-direction: column;
            height: 100%; 
        }
        #map {
            flex-grow: 1;
            background: #000;
            border-right: 2px solid var(--border-color);
            min-height: 400px; 
            height: 100%; /* è¦ªè¦ç´ ã®é«˜ã•ã«åˆã‚ã›ã‚‹ */
        }
        #weather-display {
            padding: 15px;
            background-color: var(--panel-bg);
            border-top: 1px solid var(--border-color);
            flex-shrink: 0;
        }

        /* å³å´ãƒ‘ãƒãƒ« (åˆ¶å¾¡ & ãƒ­ã‚°) */
        .right-column {
            flex: 1; 
            display: flex;
            flex-direction: column;
            padding: 15px;
            background-color: var(--panel-bg);
            border-left: 2px solid var(--border-color);
            overflow-y: auto;
            height: 100%; 
        }
        .panel {
            margin-bottom: 15px;
            padding: 10px;
            border: 1px solid var(--border-color);
            border-radius: 5px;
            background-color: #282828;
            flex-shrink: 0;
        }
        #log-panel {
             flex-grow: 1;
             min-height: 150px; 
             display: flex;
             flex-direction: column;
             overflow: hidden;
        }
        h2 {
            margin-top: 0;
            color: var(--main-text-color);
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 5px;
            font-size: 1.1em;
        }
        .sub-header {
            color: var(--warning-color);
            font-weight: bold;
            margin-top: 10px;
            font-size: 0.9em;
        }

        /* é‹è¡Œã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è¡¨ç¤º */
        #line-status-display div {
            padding: 7px;
            margin-bottom: 4px;
            border-left: 5px solid;
            font-weight: bold;
            display: flex;
            flex-direction: column;
            font-size: 0.9em;
        }
        #line-status-display .line-header {
            display: flex;
            justify-content: space-between;
        }
        #line-status-display .line-detail {
            font-size: 0.8em;
            font-weight: normal;
            margin-top: 3px;
            color: #ccc;
        }
        .status-normal { border-color: var(--normal-color); color: var(--normal-color); }
        .status-delayed { border-color: var(--warning-color); color: var(--warning-color); }
        .status-stopped { border-color: var(--danger-color); color: var(--danger-color); }

        /* ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ãƒ‘ãƒãƒ« */
        .control-input {
            display: flex;
            gap: 10px;
            margin-bottom: 8px;
        }
        .control-input input[type="text"], .control-input select {
            padding: 6px;
            border: 1px solid var(--border-color);
            background-color: #383838;
            color: var(--main-text-color);
            border-radius: 3px;
            flex-grow: 1;
        }
        .control-input button {
            padding: 6px 12px;
            border: 1px solid var(--border-color);
            background-color: #003344;
            color: var(--main-text-color);
            cursor: pointer;
            border-radius: 3px;
            transition: background-color 0.2s;
        }
        .control-input button:hover { background-color: #005577; }
        .full-width-button {
            width: 100%;
            margin-top: 5px;
            background-color: #005577 !important;
        }

        /* ãƒ­ã‚°ã‚¨ãƒªã‚¢ */
        #event-log {
            flex-grow: 1;
            overflow-y: auto;
            border: 1px solid var(--border-color);
            padding: 10px;
            background-color: #000;
        }
        .log-entry {
            padding: 2px 0;
            border-bottom: 1px dotted #333;
        }
        .log-warn { color: var(--warning-color); }
        .log-alert { color: var(--danger-color); font-weight: bold; }
        .log-info { color: var(--normal-color); }
    </style>
</head>
<body>
    <div class="header">
        çµ±åˆæŒ‡ä»¤ãƒ»é˜²ç½ã‚·ã‚¹ãƒ†ãƒ  V3.0 (æ±æ—¥æœ¬å…¨è·¯ç·šãƒ‡ãƒ¼ã‚¿æ­è¼‰ãƒ»æŒ‡ä»¤å¼·åŒ–ç‰ˆ)
    </div>

    <div class="container">
        <div class="left-column">
            <div id="map"></div>
            <div id="weather-display" class="panel">
                <h2>ğŸ“¡ ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æ°—è±¡æƒ…å ±</h2>
                <div id="weather-info">åœ°å›³ã‚’ã‚¯ãƒªãƒƒã‚¯ã™ã‚‹ã‹ã€GPSãƒœã‚¿ãƒ³ã§åœ°ç‚¹ã‚’è¨­å®šã—ã¦ãã ã•ã„ã€‚</div>
                <button class="full-width-button" onclick="getGPSLocation()">ç¾åœ¨åœ°ã‚’è¦³æ¸¬åœ°ç‚¹ã«è¨­å®š (GPS)</button>
                <div class="sub-header" style="color: yellow; margin-top: 10px;">
                    âš ï¸ æ³¨æ„: å¤–éƒ¨ã‹ã‚‰ã®é‹è¡Œæƒ…å ±ã‚¹ã‚¯ãƒ¬ã‚¤ãƒ”ãƒ³ã‚°ã¯ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ä¸Šã®åˆ¶ç´„ã«ã‚ˆã‚Šå®Ÿè¡Œã§ãã¾ã›ã‚“ã€‚ã“ã®ã‚·ã‚¹ãƒ†ãƒ ã¯ã‚ªãƒšãƒ¬ãƒ¼ã‚¿ãƒ¼ã«ã‚ˆã‚‹æ‰‹å‹•æ›´æ–°ãƒ»æŒ‡ä»¤ã‚’å‰æã¨ã—ã¦ã„ã¾ã™ã€‚
                </div>
            </div>
        </div>

        <div class="right-column">
            <div class="panel">
                <h2>ğŸš¦ é‹è¡ŒçŠ¶æ³ã‚µãƒãƒªãƒ¼ (æ±æ—¥æœ¬å…¨åŸŸ)</h2>
                <div id="line-status-display">
                    </div>
            </div>

            <div class="panel">
                <h2>âœï¸ é‹è¡ŒæŒ‡ä»¤ / çŠ¶æ³å ±å‘Š</h2>
                <div class="control-input">
                    <select id="line-select"></select>
                    <select id="status-select">
                        <option value="normal">é€šå¸¸é‹è»¢</option>
                        <option value="delayed">é…å»¶</option>
                        <option value="stopped">é‹è»¢è¦‹åˆã‚ã›</option>
                    </select>
                </div>
                <div class="control-input">
                    <input type="text" id="delay-input" placeholder="é…å»¶æ™‚é–“/è©³ç´°ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ (ä¾‹: 15åˆ†, å¼·é¢¨)">
                </div>
                <button class="full-width-button" onclick="updateLineStatus()">é‹è¡ŒçŠ¶æ³æ›´æ–°</button>
            </div>

            <div class="panel" style="border: 2px solid var(--danger-color);">
                <h2>ğŸš¨ ã‚·ã‚¹ãƒ†ãƒ è­¦å ±ç™ºå‡º (å¤šæ®µéšæŒ‡ä»¤)</h2>
                <div class="sub-header">å¯¾è±¡ãŒã€Œè¦‹åˆã‚ã›ã€ã§ã®ã¿ã‚·ã‚¹ãƒ†ãƒ å…¨ä½“ã«è­¦å ±ã‚’ç™ºå‡ºã—ã¾ã™ã€‚</div>
                <div class="control-input" style="margin-top: 5px;">
                    <input type="text" id="alert-situation-input" placeholder="çŠ¶æ³ (ä¾‹: åœŸç ‚å´©ã‚Œ, ä¿¡å·æ•…éšœ)">
                </div>
                <div class="control-input">
                    <input type="text" id="alert-message-input" placeholder="è­¦å ±è©³ç´°ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸">
                </div>
                <button class="full-width-button" onclick="triggerSystemAlert()" style="background-color: var(--danger-color) !important;">ã‚·ã‚¹ãƒ†ãƒ è­¦å ±ç™ºå‡º</button>
            </div>

            <div id="log-panel" class="panel">
                <h2>ğŸ“œ ã‚¤ãƒ™ãƒ³ãƒˆãƒ­ã‚°</h2>
                <div id="event-log"></div>
            </div>
        </div>
    </div>

    <script>
        // =========================================================
        // ğŸš¨ è¨­å®šå®šæ•° (ã“ã“ã‚’ç·¨é›†ã—ã¦ãã ã•ã„)
        // =========================================================
        const OPEN_WEATHER_API_KEY = "YOUR_OPENWEATHERMAP_API_KEY"; // ä»»æ„
        
        const MAP_DEFAULT_CENTER = [35.700, 139.750]; // æ±äº¬è¿‘éƒŠã‚’ä¸­å¿ƒ
        const INITIAL_ZOOM = 9;

        // =========================================================
        // æ±æ—¥æœ¬å…¨è·¯ç·šã®é™çš„ãƒ‡ãƒ¼ã‚¿å®šç¾© (ã‚¹ã‚¯ãƒ¬ã‚¤ãƒ”ãƒ³ã‚°ä»£æ›¿)
        // å®Ÿéš›ã®é‹è¡Œæƒ…å ±ã‚µã‚¤ãƒˆã®ã‚°ãƒ«ãƒ¼ãƒ—ã‚’æ¨¡å€£
        // =========================================================
        const EAST_JAPAN_LINES_DATA = {
            // é–¢æ±ã‚¨ãƒªã‚¢ (JRæ±æ—¥æœ¬ kanto.aspx ç›¸å½“)
            'yamate': { name: 'å±±æ‰‹ç·š', lat: 35.6895, lon: 139.7522, status: 'normal', delay: 'å®šåˆ»', detail_message: 'é‹è¡Œã«æ”¯éšœã¯ã‚ã‚Šã¾ã›ã‚“ã€‚' },
            'chuo_k': { name: 'ä¸­å¤®ç·š(å¿«é€Ÿ)', lat: 35.699, lon: 139.699, status: 'normal', delay: 'å®šåˆ»', detail_message: 'é‹è¡Œã«æ”¯éšœã¯ã‚ã‚Šã¾ã›ã‚“ã€‚' },
            'keihin': { name: 'äº¬æµœæ±åŒ—ç·š', lat: 35.7088, lon: 139.7788, status: 'normal', delay: 'å®šåˆ»', detail_message: 'é‹è¡Œã«æ”¯éšœã¯ã‚ã‚Šã¾ã›ã‚“ã€‚' },
            'tokaido': { name: 'æ±æµ·é“ç·š', lat: 35.5303, lon: 139.6380, status: 'normal', delay: 'å®šåˆ»', detail_message: 'é‹è¡Œã«æ”¯éšœã¯ã‚ã‚Šã¾ã›ã‚“ã€‚' },
            'joban': { name: 'å¸¸ç£ç·š(å¿«é€Ÿ)', lat: 35.7893, lon: 140.0632, status: 'normal', delay: 'å®šåˆ»', detail_message: 'é‹è¡Œã«æ”¯éšœã¯ã‚ã‚Šã¾ã›ã‚“ã€‚' },
            'shonan': { name: 'æ¹˜å—æ–°å®¿ãƒ©ã‚¤ãƒ³', lat: 35.6909, lon: 139.7005, status: 'normal', delay: 'å®šåˆ»', detail_message: 'é‹è¡Œã«æ”¯éšœã¯ã‚ã‚Šã¾ã›ã‚“ã€‚' },
            'ueno_tokyo': { name: 'ä¸Šé‡æ±äº¬ãƒ©ã‚¤ãƒ³', lat: 35.7088, lon: 139.7788, status: 'normal', delay: 'å®šåˆ»', detail_message: 'é‹è¡Œã«æ”¯éšœã¯ã‚ã‚Šã¾ã›ã‚“ã€‚' },
            'sotetsu': { name: 'ç›¸é‰„ç·šç›´é€š', lat: 35.4549, lon: 139.5441, status: 'normal', delay: 'å®šåˆ»', detail_message: 'é‹è¡Œã«æ”¯éšœã¯ã‚ã‚Šã¾ã›ã‚“ã€‚' },

            // æ±åŒ—ã‚¨ãƒªã‚¢ (JRæ±æ—¥æœ¬ tohoku.aspx ç›¸å½“)
            'tohoku_main': { name: 'æ±åŒ—æœ¬ç·š', lat: 38.2682, lon: 140.8711, status: 'normal', delay: 'å®šåˆ»', detail_message: 'é‹è¡Œã«æ”¯éšœã¯ã‚ã‚Šã¾ã›ã‚“ã€‚' },
            'ou': { name: 'å¥¥ç¾½æœ¬ç·š', lat: 39.7196, lon: 140.1039, status: 'normal', delay: 'å®šåˆ»', detail_message: 'é‹è¡Œã«æ”¯éšœã¯ã‚ã‚Šã¾ã›ã‚“ã€‚' },
            
            // ä¿¡è¶Šã‚¨ãƒªã‚¢ (JRæ±æ—¥æœ¬ shinetsu.aspx ç›¸å½“)
            'shinetsu_main': { name: 'ä¿¡è¶Šæœ¬ç·š', lat: 37.9149, lon: 139.0433, status: 'normal', delay: 'å®šåˆ»', detail_message: 'é‹è¡Œã«æ”¯éšœã¯ã‚ã‚Šã¾ã›ã‚“ã€‚' },
            'hakushin': { name: 'ç™½æ–°ç·š', lat: 37.9142, lon: 139.0566, status: 'normal', delay: 'å®šåˆ»', detail_message: 'é‹è¡Œã«æ”¯éšœã¯ã‚ã‚Šã¾ã›ã‚“ã€‚' },

            // æ–°å¹¹ç·š (JRæ±æ—¥æœ¬ shinkansen.aspx ç›¸å½“)
            'tohoku_s': { name: 'æ±åŒ—æ–°å¹¹ç·š', lat: 37.7508, lon: 140.4674, status: 'normal', delay: 'å®šåˆ»', detail_message: 'é‹è¡Œã«æ”¯éšœã¯ã‚ã‚Šã¾ã›ã‚“ã€‚' },
            'joetsu_s': { name: 'ä¸Šè¶Šæ–°å¹¹ç·š', lat: 36.3912, lon: 139.0607, status: 'normal', delay: 'å®šåˆ»', detail_message: 'é‹è¡Œã«æ”¯éšœã¯ã‚ã‚Šã¾ã›ã‚“ã€‚' },
            'hokuriku_s': { name: 'åŒ—é™¸æ–°å¹¹ç·š', lat: 36.6508, lon: 138.1891, status: 'normal', delay: 'å®šåˆ»', detail_message: 'é‹è¡Œã«æ”¯éšœã¯ã‚ã‚Šã¾ã›ã‚“ã€‚' },
            'yamagata_s': { name: 'å±±å½¢æ–°å¹¹ç·š', lat: 38.2599, lon: 140.3639, status: 'normal', delay: 'å®šåˆ»', detail_message: 'é‹è¡Œã«æ”¯éšœã¯ã‚ã‚Šã¾ã›ã‚“ã€‚' },
            'akita_s': { name: 'ç§‹ç”°æ–°å¹¹ç·š', lat: 39.7208, lon: 140.1037, status: 'normal', delay: 'å®šåˆ»', detail_message: 'é‹è¡Œã«æ”¯éšœã¯ã‚ã‚Šã¾ã›ã‚“ã€‚' },
        };
        
        let lines = EAST_JAPAN_LINES_DATA;
        // DOMè¦ç´ 
        const lineStatusDisplayEl = document.getElementById('line-status-display');
        const lineSelectEl = document.getElementById('line-select');
        const statusSelectEl = document.getElementById('status-select');
        const delayInputEl = document.getElementById('delay-input');
        const alertSituationInputEl = document.getElementById('alert-situation-input'); 
        const alertMessageInputEl = document.getElementById('alert-message-input'); 
        const weatherInfoEl = document.getElementById('weather-info');
        const eventLogEl = document.getElementById('event-log');

        let map = null;
        let weatherMarker = null;

        // =========================================================
        // I. åˆæœŸåŒ–
        // =========================================================

        document.addEventListener('DOMContentLoaded', () => {
            initMap();
            initLineStatusDisplay();
            renderLineStatus();
            logEvent("ã‚·ã‚¹ãƒ†ãƒ ", "V3.0 èµ·å‹•å®Œäº†ã€‚æ±æ—¥æœ¬å…¨è·¯ç·šãƒ‡ãƒ¼ã‚¿ã‚’æ­è¼‰ã€‚", "info");
        });

        function initMap() {
            map = L.map('map').setView(MAP_DEFAULT_CENTER, INITIAL_ZOOM);

            // åœ°å›³ã®ã‚µã‚¤ã‚ºã‚’ç¢ºå®Ÿã«æ›´æ–°
            setTimeout(() => {
                map.invalidateSize();
                logEvent("åœ°å›³ã‚·ã‚¹ãƒ†ãƒ ", "åœ°å›³è¡¨ç¤ºã‚µã‚¤ã‚ºã‚’èª¿æ•´å®Œäº†ã€‚", "info");
            }, 100); // ã‚ãšã‹ã«é…å»¶ã•ã›ã¦ç¢ºå®Ÿæ€§ã‚’ä¸Šã’ã‚‹

            // å›½åœŸåœ°ç†é™¢ã®æ¨™æº–åœ°å›³ã‚¿ã‚¤ãƒ«ã‚’ä½¿ç”¨ (å‰å›ã¨åŒæ§˜)
            L.tileLayer('https://cyberjapandata.gsi.go.jp/xyz/std/{z}/{x}/{y}.png', {
                maxZoom: 18,
                attribution: '&copy; <a href="https://maps.gsi.go.jp/development/ichiran.html">å›½åœŸåœ°ç†é™¢</a> | &copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>'
            }).addTo(map);

            map.on('click', onMapClick);

            // åˆæœŸã®è·¯ç·šãƒãƒ¼ã‚«ãƒ¼ã‚’é…ç½®
            Object.keys(lines).forEach(key => {
                const line = lines[key];
                const color = getMarkerColor(line.status); 
                
                const icon = L.divIcon({
                    className: 'custom-div-icon',
                    html: `<div style="background-color: ${color}; width: 15px; height: 15px; border-radius: 50%; border: 2px solid white; box-shadow: 0 0 5px ${color};"></div>`,
                    iconSize: [20, 20],
                    iconAnchor: [10, 10]
                });

                const marker = L.marker([line.lat, line.lon], { icon: icon, title: line.name }).addTo(map)
                    .bindPopup(`<b>${line.name}</b><br>çŠ¶æ³: ${getStatusText(line.status)}<br>è©³ç´°: ${line.delay}`);
                
                line.marker = marker; 
            });
        }
        
        function getStatusText(status) {
            switch(status) {
                case 'normal': return 'å¹³å¸¸é‹è»¢';
                case 'delayed': return 'é…å»¶';
                case 'stopped': return 'é‹è»¢è¦‹åˆã‚ã›';
                default: return 'ä¸æ˜';
            }
        }

        function getMarkerColor(status) {
            switch(status) {
                case 'normal': return var(--normal-color);
                case 'delayed': return var(--warning-color);
                case 'stopped': return var(--danger-color);
                default: return '#cccccc';
            }
        }

        function updateMarker(line) {
            const color = getMarkerColor(line.status);
            const icon = L.divIcon({
                className: 'custom-div-icon',
                html: `<div style="background-color: ${color}; width: 15px; height: 15px; border-radius: 50%; border: 2px solid white; box-shadow: 0 0 5px ${color};"></div>`,
                iconSize: [20, 20],
                iconAnchor: [10, 10]
            });
            line.marker.setIcon(icon);
            line.marker.setPopupContent(`<b>${line.name}</b><br>çŠ¶æ³: ${getStatusText(line.status)}<br>è©³ç´°: ${line.detail_message}`);
        }

        function initLineStatusDisplay() {
            Object.keys(lines).forEach(key => {
                const option = document.createElement('option');
                option.value = key;
                option.textContent = lines[key].name;
                lineSelectEl.appendChild(option);
            });
        }

        // =========================================================
        // II. åœ°å›³ãƒ»æ°—è±¡æƒ…å ± (GPS/API)
        // =========================================================
        
        function onMapClick(e) {
            const lat = e.latlng.lat;
            const lon = e.latlng.lng;
            setWeatherLocation(lat, lon, "åœ°å›³ã‚¯ãƒªãƒƒã‚¯");
        }
        
        function getGPSLocation() {
            if (!navigator.geolocation) {
                logEvent("åœ°ç†æƒ…å ±", "ã‚¨ãƒ©ãƒ¼: ãƒ–ãƒ©ã‚¦ã‚¶ãŒGPS (Geolocation) ã«å¯¾å¿œã—ã¦ã„ã¾ã›ã‚“ã€‚", "alert");
                return;
            }

            weatherInfoEl.innerHTML = "GPSãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ä¸­... (é«˜ç²¾åº¦)"; 

            navigator.geolocation.getCurrentPosition(
                (position) => {
                    const lat = position.coords.latitude;
                    const lon = position.coords.longitude;
                    setWeatherLocation(lat, lon, `GPSç¾åœ¨åœ° (ç²¾åº¦: ${position.coords.accuracy.toFixed(1)}m)`);
                    map.setView([lat, lon], 12); 
                },
                (error) => {
                    let msg = "";
                    if (error.code === error.PERMISSION_DENIED) {
                        msg = "ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«ã‚ˆã‚Šä½ç½®æƒ…å ±ãŒæ‹’å¦ã•ã‚Œã¾ã—ãŸã€‚";
                    } else if (error.code === error.POSITION_UNAVAILABLE) {
                        msg = "ä½ç½®æƒ…å ±ãŒåˆ©ç”¨ã§ãã¾ã›ã‚“ (è¡›æ˜Ÿæ•æ‰å¤±æ•—ãªã©)ã€‚";
                    } else if (error.code === error.TIMEOUT) {
                        msg = "ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ: å–å¾—ã«æ™‚é–“ãŒã‹ã‹ã‚Šã™ãã¾ã—ãŸã€‚";
                    } else {
                        msg = `ãã®ä»–ã‚¨ãƒ©ãƒ¼: ${error.message}`;
                    }
                    logEvent("åœ°ç†æƒ…å ±", `GPSå–å¾—ã‚¨ãƒ©ãƒ¼: ${msg}`, "alert");
                    weatherInfoEl.innerHTML = `<span style="color: var(--danger-color);">GPSå–å¾—å¤±æ•—ã€‚æ‰‹å‹•ã§è¨­å®šã—ã¦ãã ã•ã„ã€‚</span>`;
                },
                {
                    enableHighAccuracy: true, 
                    timeout: 10000,           
                    maximumAge: 0             
                }
            );
        }

        function setWeatherLocation(lat, lon, source) {
            logEvent("åœ°ç†æƒ…å ±", `${source}åº§æ¨™ã‚’è¨­å®š: Lat ${lat.toFixed(4)}, Lon ${lon.toFixed(4)}`, "info");

            const latlng = [lat, lon];
            if (weatherMarker) {
                weatherMarker.setLatLng(latlng);
            } else {
                weatherMarker = L.marker(latlng).addTo(map)
                    .bindPopup("æ°—è±¡è¦³æ¸¬åœ°ç‚¹").openPopup();
            }

            fetchWeather(lat, lon);
        }


        async function fetchWeather(lat, lon) {
            if (OPEN_WEATHER_API_KEY === "YOUR_OPENWEATHERMAP_API_KEY") {
                weatherInfoEl.innerHTML = `<span style="color: var(--danger-color);">âš ï¸ OpenWeatherMap APIã‚­ãƒ¼ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚æ°—è±¡æƒ…å ±é€£æºã‚’æœ‰åŠ¹ã«ã™ã‚‹ã«ã¯ã‚­ãƒ¼ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚</span>`;
                return;
            }

            const url = `https://api.openweathermap.org/data/2.5/weather?lat=${lat}&lon=${lon}&appid=${OPEN_WEATHER_API_KEY}&units=metric&lang=ja`;

            try {
                weatherInfoEl.innerHTML = "ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ä¸­...";
                const response = await fetch(url);
                const data = await response.json();

                if (data.cod !== 200) {
                    throw new Error(data.message || "ãƒ‡ãƒ¼ã‚¿å½¢å¼ã‚¨ãƒ©ãƒ¼");
                }

                const tempC = data.main.temp.toFixed(1);
                const weatherDesc = data.weather[0].description;
                const windSpeed = data.wind.speed.toFixed(1);
                const pressure = data.main.pressure;

                weatherInfoEl.innerHTML = `
                    <p><b>åœ°ç‚¹: ${data.name || 'è¦³æ¸¬åœ°ç‚¹'}</b> (${data.coord.lat.toFixed(2)}, ${data.coord.lon.toFixed(2)})</p>
                    <p>æ°—æ¸©: ${tempC} â„ƒ | é¢¨é€Ÿ: ${windSpeed} m/s | æ°—åœ§: ${pressure} hPa</p>
                    <p>å¤©å€™: ${weatherDesc}</p>
                `;
                
                if (windSpeed >= 15) {
                    logEvent("æ°—è±¡æ³¨æ„å ±", `${data.name}ã§å¼·é¢¨ (${windSpeed}m/s) ã‚’è¦³æ¸¬ã€‚`, "warn");
                }

            } catch (error) {
                weatherInfoEl.innerHTML = `<span style="color: var(--danger-color);">ã‚¨ãƒ©ãƒ¼: æ°—è±¡ãƒ‡ãƒ¼ã‚¿å–å¾—å¤±æ•— (${error.message})</span>`;
                logEvent("æ°—è±¡è­¦å ±", `æ°—è±¡ãƒ‡ãƒ¼ã‚¿å–å¾—ä¸­ã«ã‚¨ãƒ©ãƒ¼ç™ºç”Ÿ: ${error.message}`, "alert");
            }
        }
        
        // =========================================================
        // III. é‹è¡ŒæŒ‡ä»¤ãƒ»è¡¨ç¤º
        // =========================================================
        
        function renderLineStatus() {
            lineStatusDisplayEl.innerHTML = '';
            Object.keys(lines).forEach(key => {
                const line = lines[key];
                const statusClass = line.status === 'normal' ? 'status-normal' : 
                                    line.status === 'delayed' ? 'status-delayed' : 'status-stopped';
                
                const statusText = getStatusText(line.status);
                
                const delayDisplay = (line.status === 'delayed' || line.status === 'stopped') ? 
                                     `(${line.delay})` : '';

                const div = document.createElement('div');
                div.className = statusClass;
                div.innerHTML = `
                    <div class="line-header">
                        <span>${line.name}</span>
                        <span>${statusText} ${delayDisplay}</span>
                    </div>
                    <div class="line-detail">${line.detail_message}</div>
                `;
                lineStatusDisplayEl.appendChild(div);
                
                if (line.marker) updateMarker(line);
            });
        }

        function updateLineStatus() {
            const lineId = lineSelectEl.value;
            const newStatus = statusSelectEl.value;
            const line = lines[lineId];
            const lineName = line.name;
            const customInput = delayInputEl.value.trim(); 

            let logMessage = "";
            let logType = "info";
            let newDelay = 'å®šåˆ»';
            let newDetail = 'é‹è¡Œã«æ”¯éšœã¯ã‚ã‚Šã¾ã›ã‚“ã€‚';

            line.status = newStatus;
            
            if (newStatus === 'delayed') {
                newDelay = customInput || 'ç´„30åˆ†é…å»¶';
                newDetail = `é…å»¶ç™ºç”Ÿ: ${customInput || 'è»Šä¸¡ç‚¹æ¤œã®ãŸã‚ã€‚'}`;
                logMessage = `${lineName}ã«å¯¾ã—ã€é‹è¡Œé…å»¶ (${newDelay}) ã‚’æŒ‡ä»¤ã€‚`;
                logType = "warn";
            } else if (newStatus === 'stopped') {
                newDelay = 'é‹ä¼‘';
                newDetail = `é‹è»¢è¦‹åˆã‚ã›: ${customInput || 'åŸå› ä¸æ˜ã€‚'}`;
                logMessage = `ğŸš¨ ${lineName}ã«å¯¾ã—ã€é‹è»¢è¦‹åˆã‚ã›ã‚’æŒ‡ä»¤ã€‚è¦å› : ${newDetail}`;
                logType = "alert";
            } else { // normal
                logMessage = `${lineName}ã®é‹è¡ŒçŠ¶æ³ã‚’é€šå¸¸é‹è»¢ã«å¾©æ—§ã€‚`;
            }
            
            line.delay = newDelay;
            line.detail_message = newDetail;

            renderLineStatus();
            logEvent("é‹è¡ŒæŒ‡ä»¤", logMessage, logType);
            delayInputEl.value = ''; 
        }

        // ğŸš¨ ã‚·ã‚¹ãƒ†ãƒ è­¦å ±ã®ç™ºå‡ºãƒ­ã‚¸ãƒƒã‚¯ (é‹è»¢è¦‹åˆã‚ã›æ™‚ã®ã¿)
        function triggerSystemAlert() {
            const lineId = lineSelectEl.value;
            const line = lines[lineId];
            const currentStatus = line.status;
            const situation = alertSituationInputEl.value.trim();
            const customMessage = alertMessageInputEl.value.trim();

            if (currentStatus !== 'stopped') {
                logEvent("è­¦å ±ã‚·ã‚¹ãƒ†ãƒ ", `è­¦å ±ç™ºå‡ºå¤±æ•—: ${line.name}ã¯ã€Œé‹è»¢è¦‹åˆã‚ã›ã€çŠ¶æ…‹ï¼ˆstoppedï¼‰ã§ãªã‘ã‚Œã°ãªã‚Šã¾ã›ã‚“ã€‚`, "warn");
                return;
            }
            if (!situation || !customMessage) {
                 logEvent("è­¦å ±ã‚·ã‚¹ãƒ†ãƒ ", "è­¦å ±ç™ºå‡ºå¤±æ•—: ã€ŒçŠ¶æ³ã€ã¨ã€Œè­¦å ±è©³ç´°ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã€ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚", "warn");
                return;
            }

            const alertMessage = `ğŸš¨ ${line.name}ã§${situation}ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚ç›´ã¡ã«å¯¾å¿œã‚’è¦è«‹: ${customMessage}`;

            // ãƒ–ãƒ©ã‚¦ã‚¶ã®ãƒã‚¤ãƒ†ã‚£ãƒ–ã‚¢ãƒ©ãƒ¼ãƒˆã§ç·Šæ€¥è­¦å ±ã‚’ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ãƒˆ (ç°¡å˜ã«å‡ºãªã„ã‚ˆã†ã«ã™ã‚‹è¦æœ›ã«å¯¾å¿œ)
            alert(`ã€ã‚·ã‚¹ãƒ†ãƒ è­¦å ±: è¦ç·Šæ€¥å¯¾å¿œã€‘\nå¯¾è±¡è·¯ç·š: ${line.name} (é‹è»¢è¦‹åˆã‚ã›ä¸­)\nçŠ¶æ³: ${situation}\nè©³ç´°: ${customMessage}`);

            logEvent("ã‚·ã‚¹ãƒ†ãƒ è­¦å ±", alertMessage, "alert");

            // ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’ã‚¯ãƒªã‚¢
            alertSituationInputEl.value = '';
            alertMessageInputEl.value = '';
        }
        
        // =========================================================
        // IV. ã‚¤ãƒ™ãƒ³ãƒˆãƒ­ã‚°
        // =========================================================

        function logEvent(source, message, type = "info") {
            const entry = document.createElement('div');
            const timestamp = new Date().toLocaleTimeString('ja-JP');
            entry.className = 'log-entry';
            
            let typeClass = '';
            if (type === 'warn') {
                typeClass = 'log-warn';
            } else if (type === 'alert') {
                typeClass = 'log-alert';
            } else {
                typeClass = 'log-info';
            }

            entry.innerHTML = `<span class="${typeClass}">[${timestamp}] [${source}] ${message}</span>`;
            
            eventLogEl.prepend(entry);

            // ãƒ­ã‚°ãŒå¤šã™ãã‚‹å ´åˆã¯å¤ã„ã‚‚ã®ã‚’å‰Šé™¤
            if (eventLogEl.children.length > 150) {
                eventLogEl.removeChild(eventLogEl.lastChild);
            }
        }
    </script>
</body>
</html>
